<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!--Removes Google Crawler from indexing page-->
    <meta name="robots" content="noindex" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
  </head>

  <body>
    <script src="https://sdk-cdn.mypurecloud.com/javascript/latest/purecloud-platform-client-v2.min.js"></script>
    <script type="text/javascript">
      console.log("OFG: Loading");
      const clientId = "6f99c63b-3dfb-43cf-9792-a9b5c295d0ca";
      const redirectUri =
        "https://apmaries.github.io/outboundForecastGenerator/wfm-outbound.html";

      const appName = "outboundForecastGenerator";
      const qParamLanguage = "language";
      const qParamEnvironment = "environment";

      // Default values are assigned but values should
      // be set on the function 'assignConfiguration'
      let language = "en-us";
      let environment = "mypurecloud.com";

      let userDetails = null;

      // Configure both the Platform SDK and the Client App SDK

      function setupGenesysClients() {
        // Configure Platform SDK
        const platformClient = require("platformClient");
        const client = platformClient.ApiClient.instance;
        const usersApi = new platformClient.UsersApi();

        // Configure Client App
        let ClientApp = window.ApiClient;
        let myClientApp = new ClientApp({
          pcEnvironment: environment,
        });

        // Configure and Authenticate Platform Client
        client.setPersistSettings(true, appName);
        client.setEnvironment(environment);

        return client
          .loginImplicitGrant(clientId, redirectUri)

          .then((data) => usersApi.getUsersMe())
          .then((data) => {
            userDetails = data;

            myClientApp.alerting.showToastPopup(
              `Hi ${userDetails.name}`,
              "Never gonna give you up, never gonna let you down ðŸ˜Š"
            );
          })
          .catch((err) => console.log(err));
      }

      /**
       * Assign the language and environment for the app first through
       * the query parameters. But if non-existent, attempt to get
       * it from localStorage. If none, use default values.
       */
      function assignConfiguration() {
        /*let url = new URL(window.location);
        let searchParams = new URLSearchParams(url.search);

        if (searchParams.has(qParamLanguage)) {
          language = searchParams.get(qParamLanguage);
          localStorage.setItem(`${appName}_language`, language);
        } else {
          let local_lang = localStorage.getItem(`${appName}_language`);
          if (local_lang) language = local_lang;
        }*/

        const referrer = document.referrer;
        const prefix = "https://apps.";

        const firstSlashIndex = referrer.indexOf("/", prefix.length);
        const environment = referrer.substring(prefix.length, firstSlashIndex);
        localStorage.setItem(`${appName}_environment`, environment);
      }

      // After page loads...
      window.addEventListener("load", (event) => {
        console.log("OFG: Page loaded");
        assignConfiguration();
        console.log(`environment: ${environment}`);
        console.log(`language: ${language}`);

        setupGenesysClients().then(() => {
          // Display values to the page
          document.getElementById("span_environment").innerText = environment;
          //document.getElementById("span_language").innerText = language;
          document.getElementById("span_name").innerText = userDetails.name;

          console.log("Finished setup.");
        });
      });
    </script>
  </body>
</html>
