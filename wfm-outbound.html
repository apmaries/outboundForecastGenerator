<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!--Removes Google Crawler from indexing page-->
    <meta name="robots" content="noindex" />

    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>Outbound Forecast Generator</title>

    <script>
      console.log("Outbound Forecast Generator (OFG) initiated");
    </script>

    <!-- Genesys stuff -->
    <link
      href="https://app.inindca.com/spark-components/build-assets/4.12.0-85/genesys-webcomponents/genesys-webcomponents.css"
      rel="stylesheet"
    />
    <!-- <link
      href="https://dhqbrvplips7x.cloudfront.net/common-ui-docs/genesys-webcomponents/3.8.1-178/genesys-webcomponents/genesys-webcomponents.css"
      rel="stylesheet"
    /> -->
    <script
      type="module"
      src="https://dhqbrvplips7x.cloudfront.net/common-ui-docs/genesys-webcomponents/3.8.1-178/genesys-webcomponents/genesys-webcomponents.esm.js"
    ></script>
    <script src="https://sdk-cdn.mypurecloud.com/javascript/latest/purecloud-platform-client-v2.min.js"></script>

    <!-- External -->
    <script src="https://moment.github.io/luxon/global/luxon.min.js"></script>

    <!-- Project -->
    <script src="./src/makeApiCall.js"></script>
    <script src="./src/planningGroups.js"></script>
    <script src="./src/numberCruncher.js"></script>
    <script src="./src/importFc.js"></script>
    <script src="./src/session.js"></script>
    <script src="./src/main.js"></script>

    <style>
      /*TODO: Fix width issues*/

      .widget-container {
        max-width: 800px; /* Set the maximum width as needed */
        margin: 0 auto; /* Center the widget within the parent container */
      }

      .form-container {
        display: inline-flex;
        flex-direction: column;
        width: 100%; /* Make the widget take up 100% of the container width */
      }
      .slotted {
        font-family: Roboto, sans-serif;
        font-weight: 600;
        font-size: 12px;
        line-height: 16px;
      }
      .error {
        border: 2px solid red;
      }

      .width {
        width: 100%;
      }

      .row {
        display: flex;
        gap: 10px;
      }

      .row .width {
        flex: 1;
      }

      .align-right {
        margin-left: auto;
      }

      .align-left {
        margin-right: auto;
      }

      .page {
        display: none;

        opacity: 0;
        transition: opacity 0.5s ease-in-out;
      }

      .page.active {
        display: block;
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <div class="widget-container">
      <h1 id="heading" class="align-left">Outbound Forecast Generator</h1>
      <div id="user-welcome" class="align-left" hidden></div>

      <div id="page-one" class="page active">
        <fieldset class="form-container">
          <legend>Forecast Parameters</legend>
          <gux-loading-message-beta id="loading-message">
            <div slot="primary-message">Loading BU data...</div>
            <gux-radial-progress
              id="radial-progress"
              slot="progress"
              value="0"
              max="1000"
              screenreader-text="loading"
            ></gux-radial-progress>
          </gux-loading-message-beta>
          <div id="parameters" hidden>
            <gux-form-field-dropdown class="width">
              <gux-dropdown>
                <gux-listbox
                  id="businessUnit"
                  onchange="updateBusinessUnitSettings()"
                >
                </gux-listbox>
              </gux-dropdown>
              <label slot="label">Business Unit</label>
            </gux-form-field-dropdown>

            <gux-form-field-number>
              <input
                slot="input"
                type="number"
                id="historicalWeeks"
                value="6"
                step="1"
                min="1"
                max="8"
              />
              <label class="width" slot="label"
                >Forecast historical weeks</label
              >
            </gux-form-field-number>

            <label for="weekStart" class="slotted">Week start</label>
            <gux-datepicker
              start-day-of-week="1"
              id="weekStart"
              format="dd/mm/yyyy"
              class="width"
            ></gux-datepicker>

            <div id="toggle-sch" style="display: none">
              <!-- temporarily hidden until functionality added -->
              <label for="inclSchedule">Generate schedule too?</label>
              <gux-toggle
                id="inclSchedule"
                checked-label="Yes"
                unchecked-label="No"
              ></gux-toggle>
            </div>
            <gux-button accent="secondary" onclick="nextPage()"
              >Next</gux-button
            >
          </div>
        </fieldset>
      </div>

      <div id="page-two" class="page">
        <fieldset class="form-container">
          <legend>Planning Groups</legend>
          <div id="planning-groups">
            <gux-page-loading-spinner
              id="planning-groups-loading"
              screenreader-text="Loading..."
            ></gux-page-loading-spinner>
            <div id="planning-groups-container" style="display: none">
              <gux-table resizable-columns id="planning-groups-table" compact>
                <table slot="data">
                  <thead>
                    <tr>
                      <th data-column-name="pg-name" aria-sort="ascending">
                        Planning Group name
                        <gux-sort-control />
                      </th>
                      <th data-column-name="campaign-name">
                        Campaign name
                        <gux-sort-control include-unsorted />
                      </th>
                      <th data-column-name="n-contacts" data-cell-numeric>
                        Number of contacts
                      </th>
                    </tr>
                  </thead>
                  <tbody></tbody></table
              ></gux-table>
              <label for="ignoreZeroes"
                >Ignore zero values when generating averages?</label
              >
              <gux-toggle
                id="ignoreZeroes"
                checked-label="Yes"
                unchecked-label="No"
                checked
              ></gux-toggle>
            </div>
          </div>
          <div id="buttons" class="row" style="padding-top: 20px">
            <gux-button
              accent="secondary"
              class="align-left"
              onclick="prevPage()"
              >Back</gux-button
            >
            <gux-button
              accent="primary"
              class="align-right"
              onclick="buttonClicked()"
              >Run!</gux-button
            >
          </div>
        </fieldset>
      </div>
      <div id="test-mode" class="align-left" hidden></div>

      <script>
        (function () {
          function ascending(a, b) {
            if (a.textContent < b.textContent) {
              return -1;
            }
            if (a.textContent > b.textContent) {
              return 1;
            }
            return 0;
          }

          function shuffle(a, b) {
            return 0.5 - Math.random();
          }

          const table = document.querySelector("#planning-group-table");

          table.addEventListener("guxsortchanged", (event) => {
            const { columnName, sortDirection } = event.detail;

            const columns = Array.from(
              table.querySelectorAll("thead tr th")
            ).forEach((column) => column.removeAttribute("aria-sort"));
            const column = table.querySelector(
              `thead tr th[data-column-name='` + columnName + `']`
            );
            column.setAttribute("aria-sort", sortDirection);

            const tableBody = table.querySelector("tbody");

            switch (sortDirection) {
              case "ascending":
                [...tableBody.children]
                  .sort(ascending)
                  .forEach((node) => tableBody.appendChild(node));
                break;
              case "descending":
                [...tableBody.children]
                  .sort(ascending)
                  .reverse()
                  .forEach((node) => tableBody.appendChild(node));
                break;
              default:
                [...tableBody.children]
                  .sort(shuffle)
                  .forEach((node) => tableBody.appendChild(node));
                break;
            }
          });
        })();
      </script>

      <script>
        var test = true;
        var token = sessionStorage.getItem("token");
        const wfmBuStorage = "wfmBuList";
        var selectedBuId;
        var selectedBuTimeZone;

        // Set Genesys Cloud objects
        /*const platformClient = require("platformClient");
        const client = platformClient.ApiClient.instance;
        client.setAccessToken(token);

        const oapi = new platformClient.OrganizationApi();
        const uapi = new platformClient.UsersApi();
        const wapi = new platformClient.WorkforceManagementApi();*/

        // TODO: Add generic error handling

        async function fetchBusinessUnits(allBuData, nBu) {
          const buArray = [];
          // set progress max
          let radialProgress = document.getElementById("radial-progress");
          let progressValue = 0;
          radialProgress.setAttribute("max", nBu.toString());

          let allTzData = await fetchDataWithRetry(
            `/api/v2/timezones?pageSize=500&pageNumber=1`,
            "GET"
          );

          // get individual BU settings
          console.log(`OFG: Getting BU settings`);
          for (let b = 0; b < allBuData.length; b++) {
            progressValue++;
            let businessUnitId = allBuData[b].id;
            let businessUnitName = allBuData[b].name;

            let buData = await fetchDataWithRetry(
              `/api/v2/workforcemanagement/businessunits/${businessUnitId}?expand=settings.timeZone,settings.startDayOfWeek,settings.shortTermForecasting`,
              "GET"
            );

            // increment progress
            radialProgress.setAttribute("value", progressValue);

            // get bu settings
            let businessUnitStartDayOfWeek = buData.settings.startDayOfWeek;
            let businessUnitDefaultHistoryWeeks =
              buData.settings.shortTermForecasting.defaultHistoryWeeks;

            let businessUnitTimeZone = buData.settings.timeZone;
            let timezoneOffset = allTzData.find(
              (tz) => tz.id === businessUnitTimeZone
            );
            let businessUnitTimeZoneOffset = timezoneOffset.offset;

            let bu = {
              "name": businessUnitName,
              "id": businessUnitId,
              "startDayOfWeek": businessUnitStartDayOfWeek,
              "defaultHistoryWeeks": businessUnitDefaultHistoryWeeks,
              "timeZone": businessUnitTimeZone,
              "offset": businessUnitTimeZoneOffset,
            };
            console.debug(`OFG: ${JSON.stringify(bu)}`);
            buArray.push(bu);
          }

          // set session storage
          sessionStorage.setItem(wfmBuStorage, JSON.stringify(buArray));

          return buArray;
        }

        // Populate Business Unit dropdown options
        async function populateBusinessUnits(businessUnits) {
          var businessUnitDropdown = document.getElementById("businessUnit");

          // Sort the buData array alphabetically based on bu_name
          businessUnits.sort((a, b) => a.name.localeCompare(b.name));

          for (let i = 0; i < businessUnits.length; i++) {
            const unit = businessUnits[i];
            var option = document.createElement("gux-option");
            option.value = unit.id;
            option.textContent = unit.name;
            businessUnitDropdown.appendChild(option);
          }
        }

        // Update selected Business Unit settings
        function updateBusinessUnitSettings() {
          const buArray = JSON.parse(sessionStorage.getItem(wfmBuStorage));

          var businessUnitDropdown = document.getElementById("businessUnit");
          var selectedBuId = businessUnitDropdown.value;
          console.log(
            `OFG: User selected BU - ${JSON.stringify(selectedBuId)}`
          );

          // BU variables
          var buObj = buArray.find((unit) => unit.id === selectedBuId);
          console.debug(`OFG: ${JSON.stringify(buObj)}`);

          var selectedBuStartDayOfWeek = buObj.startDayOfWeek;
          var selectedBuTimeZone = buObj.timeZone;
          var selectedBuDefaultHistoryWeeks = buObj.defaultHistoryWeeks;

          // Set default value for historicalWeeks
          document.getElementById("historicalWeeks").value =
            selectedBuDefaultHistoryWeeks;

          // Set weekStart element
          var weekStartInput = document.getElementById("weekStart");

          // TODO: Fix start-day-of-week attribute always defaults to 0 (Sunday)
          // set weekStartInput start-day-of-week attribute to the selected BU's startDayOfWeek
          weekStartInput.setAttribute(
            "start-day-of-week",
            getDayOfWeek(selectedBuStartDayOfWeek).toString()
          );

          // temporary debug
          console.debug(
            `OFG: start-day-of-week set to ${getDayOfWeek(
              selectedBuStartDayOfWeek
            ).toString()}`
          );
          console.debug(weekStartInput);

          // Set default value for weekStart to the next occurrence of startDayOfWeek in the specified time zone
          var currentDate = luxon.DateTime.now({ zone: selectedBuTimeZone });
          var currentDayOfWeek = getDayOfWeek(currentDate.weekdayLong);

          // temporary debug
          console.debug(
            `OFG: currentDayOfWeek is ${currentDayOfWeek} (${currentDate.weekdayLong})`
          );

          // Adjust for Monday as the start of the week
          var daysUntilNextStartDay =
            (getDayOfWeek(selectedBuStartDayOfWeek) - currentDayOfWeek + 7) % 7;
          var nextStartDay = currentDate.plus({ days: daysUntilNextStartDay });
          var nextStartDayString = nextStartDay.toFormat("yyyy-MM-dd");
          weekStartInput.value = nextStartDayString;

          // temporary debug
          console.debug(
            `OFG: daysUntilNextStartDay is ${daysUntilNextStartDay}`
          );
          console.debug(`OFG: nextStartDay is ${nextStartDay}`);
          console.debug(`OFG: nextStartDayString is ${nextStartDayString}`);

          return buObj;
        }

        // Helper function to get day of week index (0-6) from day name
        function getDayOfWeek(dayName) {
          var days = [
            "Sunday",
            "Monday",
            "Tuesday",
            "Wednesday",
            "Thursday",
            "Friday",
            "Saturday",
          ];
          return days.indexOf(dayName);
        }

        // Populate default values on page load
        window.onload = async function () {
          await getOrgLevelStuff();

          if (test) {
            console.log("OFG: Running in test mode");

            // add element test-mode dive
            var testDiv = document.getElementById("test-mode");
            const testP = document.createElement("p");
            testP.textContent = `Running in test mode`;
            testP.style.color = "red";
            testDiv.appendChild(testP);
            testDiv.removeAttribute("hidden");

            // load test data
            fetch("./test/wfmBuList.json")
              .then((response) => response.json())
              .then((testBuList) => {
                var buArray = testBuList;
                sessionStorage.setItem(wfmBuStorage, JSON.stringify(buArray));
                populateBusinessUnits(buArray);
              })
              .catch((error) => {
                console.error(error);
              });
          } else {
            console.log("OFG: Running in production mode");
            let buData;

            let allBuData = await fetchDataWithRetry(
              `/api/v2/workforcemanagement/businessunits`,
              "GET"
            );
            let buCount = allBuData.length;

            if (buCount > 0) {
              await populateBusinessUnits(allBuData);
              console.log(`OFG: Found ${buCount} Business Units in WFM`);
              const buArray = await fetchBusinessUnits(allBuData, buCount);
            } else {
              console.error(`OFG: No business units found in WFM`);
            }
          }

          // unhide parameters div
          const loadingMessageElement =
            document.getElementById("loading-message");
          loadingMessageElement.style.display = "none";
          document.getElementById("parameters").removeAttribute("hidden");
        };

        // buttonClicked function
        function buttonClicked() {
          // Get input values
          const buArray = JSON.parse(sessionStorage.getItem(wfmBuStorage));

          var businessUnitDropdown = document.getElementById("businessUnit");
          var selectedBuId = businessUnitDropdown.value;
          console.log(`OFG: Running for BU - ${JSON.stringify(selectedBuId)}`);

          // BU variables
          var buObj = buArray.find((unit) => unit.id === selectedBuId);
          var selectedBuName = buObj.name;
          var selectedBuStartDayOfWeek = buObj.startDayOfWeek;
          var selectedBuTimeZone = buObj.timeZone;
          var selectedBuDefaultHistoryWeeks = buObj.defaultHistoryWeeks;

          // page one variables start
          var weekStartInput = document.getElementById("weekStart");
          var historicalWeeks = document.getElementById("historicalWeeks");
          var selectedWeekStart = new Date(weekStartInput.value);
          // page one variables end

          // page two variables start
          planningGroupContactsArray = [];
          const tableBody = document.querySelector(
            "#planning-groups-table tbody"
          );
          const rows = tableBody.querySelectorAll("tr");

          // loop through table rows
          for (let i = 0; i < rows.length; i++) {
            const row = rows[i];

            // get textContent of each cell
            const cells = row.querySelectorAll("td");

            // Get PG name and ID
            const pgNameCell = row.querySelector("td:first-child");
            const pgName = pgNameCell.textContent;
            const pgId = pgNameCell.dataset.pgId;
            const cpNameCell = row.querySelector("td:nth-child(2)");

            let planningGroupContacts = {
              "pgName": pgName,
              "pgId": pgId,
            };

            // check value of cpNameCell.dataset.matchedCampaign
            if (cpNameCell.dataset.matchedCampaign === "true") {
              const cpName = cpNameCell.textContent;
              const cpId = cpNameCell.dataset.campaignId;

              // Get number of contacts
              const numContactsInput = document.getElementById(
                `nContacts_${pgId}`
              );
              const numContacts = numContactsInput.value;

              planningGroupContacts["cpName"] = cpName;
              planningGroupContacts["cpId"] = cpId;
              planningGroupContacts["numContacts"] = numContacts;
            }

            // TODO: Fix data validation
            /*
          // Check if numContacts is 0
          if (numContacts === "0") {
            alert("Number of Contacts must be greater than 0.");
            console.error("OFG: Number of Contacts must be greater than 0.");
            highlightInputError(numContactsCell);
            return;
          } else {
            removeInputError(numContactsCell);
          }

          // Check if numContacts is a positive integer
          if (!/^\d+$/.test(numContacts)) {
            alert("Number of Contacts must be a positive integer.");
            console.error(
              "OFG: Number of Contacts must be a positive integer."
            );
            highlightInputError(numContactsCell);
            return;
          } else {
            removeInputError(numContactsCell);
          }
          */

            planningGroupContactsArray.push(planningGroupContacts);
          }

          // get value of ignoreZeroes
          var ignoreZeroes = document.getElementById("ignoreZeroes").checked;

          // TODO: Fix data validation
          // Check if weekStart day of week matches selected BU's startDayOfWeek
          /*if (
          selectedWeekStart.getDay() !== getDayOfWeek(selectedBuStartDayOfWeek)
        ) {
          alert(
            "Week Start day must match Business Unit's startDayOfWeek (" +
              selectedBuStartDayOfWeek +
              ")."
          );
          console.error(
            "OFG: Week Start day must match Business Unit's startDayOfWeek (" +
              selectedBuStartDayOfWeek +
              ")."
          );
          highlightInputError(weekStartInput);
          return;
        } else {
          removeInputError(weekStartInput);
        }*/

          runGenerator(
            test,
            selectedBuName,
            selectedBuId,
            selectedBuTimeZone,
            weekStartInput.value,
            historicalWeeks.value,
            planningGroupContactsArray,
            ignoreZeroes
          );
        }

        // Helper function to highlight input error
        function highlightInputError(inputElement) {
          inputElement.classList.add("error");
        }

        // Helper function to remove input error highlight
        function removeInputError(inputElement) {
          inputElement.classList.remove("error");
        }

        function nextPage() {
          const pageOne = document.getElementById("page-one");
          const pageTwo = document.getElementById("page-two");

          pageOne.classList.remove("active");

          setTimeout(() => {
            pageTwo.classList.add("active");

            var businessUnitDropdown = document.getElementById("businessUnit");
            var selectedBuId = businessUnitDropdown.value;
            loadPageTwo(selectedBuId);
          }, 100); // Delay for a smoother transition
        }

        function prevPage() {
          document.getElementById("page-two").classList.remove("active");
          setTimeout(() => {
            document.getElementById("page-one").classList.add("active");
          }, 100); // Delay for a smoother transition
        }
      </script>
    </div>
  </body>
</html>
