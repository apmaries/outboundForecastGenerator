<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!--Removes Google Crawler from indexing page-->
    <meta name="robots" content="noindex" />

    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>Outbound Forecast Generator</title>

    <script>
      console.log("Outbound Forecast Generator (OFG) initiated");
    </script>

    <!-- Genesys stuff -->
    <link
      href="https://app.inindca.com/spark-components/build-assets/4.12.0-85/genesys-webcomponents/genesys-webcomponents.css"
      rel="stylesheet"
    />
    <!-- <link
      href="https://dhqbrvplips7x.cloudfront.net/common-ui-docs/genesys-webcomponents/3.8.1-178/genesys-webcomponents/genesys-webcomponents.css"
      rel="stylesheet"
    /> -->
    <script
      type="module"
      src="https://dhqbrvplips7x.cloudfront.net/common-ui-docs/genesys-webcomponents/3.8.1-178/genesys-webcomponents/genesys-webcomponents.esm.js"
    ></script>
    <script src="https://sdk-cdn.mypurecloud.com/javascript/latest/purecloud-platform-client-v2.min.js"></script>

    <!-- External -->
    <script src="https://moment.github.io/luxon/global/luxon.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>

    <!-- Project -->

    <!-- temp removal of imports
    <script src="./src/planningGroups.js"></script>
    <script src="./src/numberCruncher.js"></script>
    <script src="./src/importFc.js"></script>
    <script src="./src/session.js"></script>
    <script src="./src/main.js"></script>
    -->

    <style>
      /*TODO: Fix width issues*/

      .widget-container {
        max-width: 95%; /* Set the maximum width as needed */
        margin: 0 auto; /* Center the widget within the parent container */
      }

      .form-container {
        display: inline-flex;
        flex-direction: column;
        width: 100%; /* Make the widget take up 100% of the container width */
      }
      .slotted {
        font-family: Roboto, sans-serif;
        font-weight: 600;
        font-size: 12px;
        line-height: 16px;
      }
      .error {
        border: 2px solid red;
      }

      .width {
        width: 100%;
      }

      .row {
        display: flex;
        gap: 10px;
      }

      .row .width {
        flex: 1;
      }

      .align-right {
        margin-left: auto;
      }

      .align-left {
        margin-right: auto;
      }

      .page {
        display: none;

        opacity: 0;
        transition: opacity 0.5s ease-in-out;
      }

      .page.active {
        display: block;
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <div class="widget-container">
      <h1 id="heading" class="align-left">Outbound Forecast Generator</h1>
      <div id="user-welcome" class="align-left" hidden></div>

      <div id="page-one" class="page active">
        <fieldset class="form-container">
          <legend>Forecast Parameters</legend>
          <gux-loading-message-beta id="loading-message">
            <div slot="primary-message">Loading BU data...</div>
            <gux-radial-progress
              id="radial-progress"
              slot="progress"
              value="0"
              max="1000"
              screenreader-text="loading"
            ></gux-radial-progress>
          </gux-loading-message-beta>
          <div id="parameters" hidden>
            <gux-form-field-dropdown class="width">
              <gux-dropdown>
                <gux-listbox
                  id="businessUnit"
                  onchange="updateBusinessUnitSettings()"
                >
                </gux-listbox>
              </gux-dropdown>
              <label slot="label">Business Unit</label>
            </gux-form-field-dropdown>

            <gux-form-field-number>
              <input
                slot="input"
                type="number"
                id="historicalWeeks"
                value="6"
                step="1"
                min="1"
                max="8"
              />
              <label class="width" slot="label"
                >Forecast historical weeks</label
              >
            </gux-form-field-number>

            <label for="weekStart" class="slotted">Week start</label>
            <gux-datepicker
              start-day-of-week="1"
              id="weekStart"
              format="dd/mm/yyyy"
              class="width"
            ></gux-datepicker>

            <div id="toggle-sch" style="display: none">
              <!-- temporarily hidden until functionality added -->
              <label for="inclSchedule">Generate schedule too?</label>
              <gux-toggle
                id="inclSchedule"
                checked-label="Yes"
                unchecked-label="No"
              ></gux-toggle>
            </div>
            <gux-button accent="secondary" onclick="nextPage()"
              >Next</gux-button
            >
          </div>
        </fieldset>
      </div>

      <div id="page-two" class="page">
        <fieldset class="form-container">
          <legend>Planning Groups</legend>
          <div id="planning-groups">
            <gux-page-loading-spinner
              id="planning-groups-loading"
              screenreader-text="Loading..."
            ></gux-page-loading-spinner>
            <div id="planning-groups-container" style="display: none">
              <gux-table resizable-columns id="planning-groups-table" compact>
                <table slot="data">
                  <thead>
                    <tr>
                      <th data-column-name="pg-name" aria-sort="ascending">
                        Planning Group name
                        <gux-sort-control />
                      </th>
                      <th data-column-name="campaign-name">
                        Campaign name
                        <gux-sort-control include-unsorted />
                      </th>
                      <th data-column-name="n-contacts" data-cell-numeric>
                        Number of contacts
                      </th>
                    </tr>
                  </thead>
                  <tbody></tbody></table
              ></gux-table>
              <label for="ignoreZeroes"
                >Ignore zero values when generating averages?</label
              >
              <gux-toggle
                id="ignoreZeroes"
                checked-label="Yes"
                unchecked-label="No"
                checked
              ></gux-toggle>
            </div>
          </div>
          <div id="buttons" class="row" style="padding-top: 20px">
            <gux-button
              accent="secondary"
              class="align-left"
              onclick="prevPage()"
              >Back</gux-button
            >
            <gux-button
              accent="primary"
              class="align-right"
              onclick="buttonClicked()"
              >Run!</gux-button
            >
          </div>
        </fieldset>
      </div>
      <div id="test-mode" class="align-left" hidden></div>

      <!-- Include the CJS SDK -->
      <script src="https://sdk-cdn.mypurecloud.com/javascript/188.0.0/purecloud-platform-client-v2.min.js"></script>
      <script>
        // Variables
        var test = true;
        // Configure the PureCloud API client
        const platformClient = require("platformClient");
        const client = platformClient.ApiClient.instance;

        // OAuth configuration
        const clientId = "6f99c63b-3dfb-43cf-9792-a9b5c295d0ca";
        const redirectUri = encodeURIComponent(window.location.href); // Redirect back to the same page

        // Check if there is an access token in the URL hash fragment
        const accessToken = window.location.hash.substr(1);

        // Functions and methods
        async function getUserInfo() {
          const usersApi = new platformClient.UsersApi();
          const userDetails = await usersApi.getUsersMe();
          console.log("User Details:", userDetails);
        }

        // Main logic
        if (accessToken) {
          // Access token is present, use it to authenticate the client
          client.setAccessToken(accessToken);
          getUserInfo();
        } else {
          // Access token is not present, initiate the implicit grant flow
          client
            .loginImplicitGrant(clientId, redirectUri)
            .then(() => {
              console.log("OFG: Logging in to GC");
            })
            .catch((error) => console.error("Error logging in:", error));
        }
      </script>
    </div>
  </body>
</html>
