<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!--Removes Google Crawler from indexing page-->
    <meta name="robots" content="noindex" />

    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>Outbound Forecast Generator</title>

    <script>
      console.log("Outbound Forecast Generator [OFG] initiated");
    </script>

    <!-- Styles -->
    <link rel="stylesheet" href="/outboundForecastGenerator/styles/main.css" />

    <!-- Genesys stuff -->
    <link
      href="https://dhqbrvplips7x.cloudfront.net/common-ui-docs/genesys-webcomponents/3.8.1-178/genesys-webcomponents/genesys-webcomponents.css"
      rel="stylesheet"
    />
    <script
      type="module"
      src="https://dhqbrvplips7x.cloudfront.net/common-ui-docs/genesys-webcomponents/3.8.1-178/genesys-webcomponents/genesys-webcomponents.esm.js"
    ></script>

    <!-- External -->
    <script src="https://moment.github.io/luxon/global/luxon.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
  </head>
  <body>
    <div class="widget-container">
      <h1 id="heading" class="align-left">Outbound Forecast Generator</h1>
      <div id="user-welcome" class="align-left" hidden></div>
      <!-- Loading section -->
      <section id="main-loading-section">
        <gux-page-loading-spinner
          screenreader-text="Loading..."
        ></gux-page-loading-spinner>
      </section>
      <!-- Main -->
      <main id="main">
        <!-- Page 1 - Set BU, Forecast week start and historical weeks range -->
        <div id="page-one" class="active-page">
          <fieldset id="page-one-fieldset">
            <legend>Parameters</legend>

            <div id="parameters">
              <gux-form-field-dropdown class="width">
                <gux-dropdown id="business-unit-dropdown">
                  <gux-listbox id="business-unit-listbox"> </gux-listbox>
                </gux-dropdown>
                <label slot="label">Business Unit</label>
              </gux-form-field-dropdown>
              <div id="bu-settings-div">
                <div style="width: 152px">
                  <gux-form-field-text-like label-position="above">
                    <label slot="label">Time zone</label>
                    <input
                      id="bu-timezone"
                      slot="input"
                      type="text"
                      value=""
                      disabled
                    />
                  </gux-form-field-text-like>
                </div>

                <div>
                  <label slot="label" class="slotted" id="week-start-label"
                    >Week start</label
                  >
                  <gux-datepicker
                    id="week-start"
                    format="dd/mm/yyyy"
                  ></gux-datepicker>
                </div>

                <div>
                  <gux-form-field-number label-position="above">
                    <label slot="label">Historical weeks</label>
                    <input
                      slot="input"
                      type="number"
                      id="historical-weeks"
                      value="6"
                      step="1"
                      min="1"
                      max="8"
                    />
                  </gux-form-field-number>
                </div>
              </div>

              <div id="toggle-sch" style="display: none">
                <!-- temporarily hidden until functionality added -->
                <label for="inclSchedule">Generate schedule too?</label>
                <gux-toggle
                  id="inclSchedule"
                  checked-label="Yes"
                  unchecked-label="No"
                ></gux-toggle>
              </div>
              <gux-button id="p1-next-button" accent="secondary"
                >Next</gux-button
              >
            </div>
          </fieldset>
        </div>

        <!-- Page 2 - Set description, contacts per PG and other options -->
        <div id="page-two" class="inactive-page">
          <fieldset id="page-two-fieldset">
            <legend>Inputs</legend>
            <div id="planning-groups">
              <gux-page-loading-spinner
                id="planning-groups-loading"
                screenreader-text="Loading..."
              ></gux-page-loading-spinner>

              <div id="planning-groups-container" style="display: none">
                <div id="fc-description-input">
                  <gux-form-field-text-like>
                    <input
                      id="fc-description"
                      slot="input"
                      type="text"
                      placeholder="Enter a description"
                    />
                    <label slot="label">Forecast description</label>
                  </gux-form-field-text-like>
                </div>
                <gux-table-beta id="planning-groups-table" compact>
                  <table slot="data">
                    <thead>
                      <tr>
                        <th data-column-name="p-name" style="width: 90%">
                          Planning Group<br /><span class="italic-gray"
                            >[Campaign]</span
                          >
                        </th>
                        <!-- Consolidated to single column
                        <th data-column-name="c-name">Campaign</th>
                      -->
                        <th data-column-name="n-contacts"># Contacts</th>
                      </tr>
                    </thead>
                    <tbody></tbody></table
                ></gux-table-beta>
              </div>
              <div>
                <fieldset>
                  <!-- Ignores full days of zero contacts (e.g. public holidays) -->
                  <legend>Outbound options</legend>
                  <label for="ignore-zeroes"
                    >Ignore zero days when generating averages?
                    <gux-icon
                      icon-name="help"
                      screenreader-text="help-icon"
                    ></gux-icon
                    ><gux-tooltip
                      >Exclude days of zero values (e.g. closed public holiday)
                      during forecast generation to prevent distortion of
                      results.</gux-tooltip
                    ></label
                  >
                  <gux-toggle
                    id="ignore-zeroes"
                    checked-label="Yes"
                    unchecked-label="No"
                    checked
                  ></gux-toggle>
                  <!-- Applies the daily AHT value to any interval with forecast offered but no AHT forecast -->
                  <!-- Not currently needed
                  <label for="resolve-contacts-aht"
                    >Resolve AHT forecast to Contacts?
                    <gux-icon
                      icon-name="help"
                      screenreader-text="help-icon"
                    ></gux-icon
                    ><gux-tooltip
                      >Make sure the forecast being generated always has AHT in
                      the same intervals as offered. (e.g. no intervals with
                      forecast offered but no handle time)</gux-tooltip
                    ></label
                  >
                 

                  <gux-toggle
                    id="resolve-contacts-aht"
                    checked-label="Yes"
                    unchecked-label="No"
                    checked
                  ></gux-toggle>
                  -->
                </fieldset>
                <div id="inbound-forecast-div" style="display: none">
                  <!-- Hidden until Planning Groups identified with no matching Campaign -->
                  <fieldset>
                    <legend>Inbound options</legend>

                    <label for="generate-inbound-fc"
                      >Generate forecast for inbound Planning Groups?
                      <gux-icon
                        icon-name="help"
                        screenreader-text="help-icon"
                      ></gux-icon
                      ><gux-tooltip
                        >Generates an ABM forecast for BU Planning Groups and
                        merges results with Outbound data</gux-tooltip
                      ></label
                    >
                    <gux-toggle
                      id="generate-inbound-fc"
                      checked-label="Yes"
                      unchecked-label="No"
                      checked
                    ></gux-toggle>

                    <label for="retain-inbound-fc"
                      >Retain forecast for inbound Planning Groups?
                      <gux-icon
                        icon-name="help"
                        screenreader-text="help-icon"
                      ></gux-icon
                      ><gux-tooltip
                        >If yes, the automatically generated inbound forecast
                        will be retained for reference.<br />If no, this inbound
                        forecast is deleted after forecasts have been
                        merged.</gux-tooltip
                      ></label
                    >
                    <gux-toggle
                      id="retain-inbound-fc"
                      checked-label="Yes"
                      unchecked-label="No"
                    ></gux-toggle>
                  </fieldset>
                </div>
              </div>
            </div>
            <div id="page-two-buttons" class="row" style="padding-top: 20px">
              <gux-button
                id="p2-back-button"
                name="back-button"
                accent="secondary"
                class="align-left"
                >Back</gux-button
              >
              <gux-button id="generate-button" accent="primary"
                >Generate</gux-button
              >
            </div>
          </fieldset>
        </div>

        <!-- Page 3 - Visualise forecast outputs prior to import -->
        <div id="page-three" class="inactive-page">
          <fieldset id="page-three-fieldset">
            <legend>Outputs</legend>
            <div id="generate-loading-div">
              <gux-loading-message>
                <div slot="primary-message" id="generate-loading-message">
                  Generating forecast
                </div>

                <gux-radial-progress
                  slot="progress"
                  screenreader-text="loading"
                ></gux-radial-progress>
                <div slot="additional-guidance">Thank you for waiting.</div>
              </gux-loading-message>
            </div>
            <div id="forecast-outputs-container" style="display: none">
              <gux-form-field-dropdown class="width">
                <gux-dropdown id="planning-group-dropdown" disabled>
                  <gux-listbox id="planning-group-listbox"> </gux-listbox>
                </gux-dropdown>
                <label slot="label">Planning Group</label>
              </gux-form-field-dropdown>
              <gux-form-field-dropdown class="width">
                <gux-dropdown
                  id="week-day-dropdown"
                  placeholder="Select a Planning Group"
                  disabled
                >
                  <gux-listbox id="week-day-listbox"> </gux-listbox>
                </gux-dropdown>
                <label slot="label">Day of Week</label>
              </gux-form-field-dropdown>
              <div id="chart"></div>
              <div id="totals-table" hidden>
                <gux-table-beta>
                  <table slot="data">
                    <thead>
                      <tr>
                        <th data-column-name="totals-interval">Total for</th>
                        <th data-column-name="forecast-offered">
                          Forecast Offered
                        </th>
                        <th data-column-name="forecast-aht">Forecast AHT</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr id="fc-day-tr">
                        <td id="fc-day-tr-heading">Day</td>
                        <td id="fc-day-offered">0</td>
                        <td id="fc-day-aht">0</td>
                      </tr>
                      <tr id="fc-week-tr">
                        <td>Week</td>
                        <td id="fc-week-offered">0</td>
                        <td id="fc-week-aht">0</td>
                      </tr>
                    </tbody>
                  </table>
                </gux-table-beta>
              </div>
              <div id="controls" hidden>
                <gux-form-field-dropdown>
                  <gux-dropdown
                    id="metric-select"
                    placeholder="Select a Metric"
                  >
                    <gux-listbox>
                      <gux-option value="offered">Offered</gux-option>
                      <gux-option value="aver-handle-time"
                        >Average Handle Time</gux-option
                      >
                      <gux-option value="both">Both</gux-option>
                    </gux-listbox>
                  </gux-dropdown>
                  <label slot="label">Metric</label>
                </gux-form-field-dropdown>

                <gux-button id="smooth-button" accent="tertiary"
                  >Smooth
                  <gux-tooltip>
                    Smooth with 3 point moving average
                  </gux-tooltip></gux-button
                >
                <gux-button id="trendline-button" accent="tertiary"
                  >Trendline
                  <gux-tooltip>
                    Create a trendline using linear regression
                  </gux-tooltip></gux-button
                >
                <gux-button id="flatten-button" accent="tertiary"
                  >Flatten<gux-tooltip>
                    Flatten to single value
                  </gux-tooltip></gux-button
                >
                <gux-button id="reset-button" accent="danger"
                  >Reset<gux-tooltip>
                    Reset back to original values
                  </gux-tooltip></gux-button
                >
              </div>
            </div>
            <div id="page-three-buttons" class="row" style="padding-top: 20px">
              <gux-button
                id="p3-back-button"
                name="back-button"
                accent="secondary"
                class="align-left"
                >Back</gux-button
              >

              <gux-button
                id="import-button"
                accent="primary"
                class="align-right"
                >Import</gux-button
              >
            </div>
          </fieldset>
        </div>

        <!-- Page 4 - Display import response -->
        <div id="page-four" class="inactive-page">
          <fieldset id="page-four-fieldset">
            <legend>Results</legend>
            <div id="import-loading-div">
              <gux-loading-message>
                <div slot="primary-message" id="import-loading-message">
                  Generating import URL
                </div>

                <gux-radial-progress
                  slot="progress"
                  screenreader-text="loading"
                ></gux-radial-progress>
                <div slot="additional-guidance">Thank you for waiting.</div>
              </gux-loading-message>
            </div>
            <div id="import-results-container" style="display: none"></div>
          </fieldset>
        </div>
        <div id="test-mode" class="align-left" hidden></div>
      </main>
      <footer><img src="./img/logo-black.png" /></footer>
    </div>

    <!-- Error handling -->
    <script>
      // Define a global error handler function
      window.onerror = function (message, source, lineno, colno, error) {
        console.error("[OFG] An error occurred:", message);
        console.error("[OFG] Source:", source);
        console.error("[OFG] Line:", lineno);
        console.error("[OFG] Column:", colno);
        console.error("[OFG] Error object:", error);
      };
    </script>

    <!-- Global variables -->
    <script>
      // Define global variables
      window.ofg = window.ofg || {};

      // Check testing mode by protocol. If https then production, else testing
      window.ofg.isTesting = window.location.protocol !== "https:";

      // Update the test-mode div with the current mode
      const testModeDiv = document.getElementById("test-mode");
      testModeDiv.textContent = `Running in ${
        window.ofg.isTesting ? "test" : "production"
      } mode`;

      // Remove hidden attribute from testModeDiv if in testing mode
      if (window.ofg.isTesting) {
        testModeDiv.removeAttribute("hidden");
      }
    </script>

    <!-- Load the PureCloud platform client library -->
    <script src="https://sdk-cdn.mypurecloud.com/javascript/latest/purecloud-platform-client-v2.min.js"></script>

    <script src="https://sdk-cdn.mypurecloud.com/javascript/1291.1.0/purecloud-platform-client-internal-v2.min.js"></script>

    <!-- Load the Client App SDK-->
    <script src="https://sdk-cdn.mypurecloud.com/client-apps/2.6.6/purecloud-client-app-sdk.js"></script>

    <!-- Define the Clients -->
    <script>
      // TODO: Need to be able to get the environment from the parent window
      var environment = "mypurecloud.com.au";

      // Check if in testing mode
      if (window.ofg.isTesting) {
        console.log("[OFG] Testing mode");

        // Fetch static JSON data
        let outboundAggregatesDataPromise = fetch(
          "/outboundForecastGenerator/test/source/outboundAggregateData.json"
        )
          .then((response) => response.json())
          .catch((error) =>
            console.error(
              "[OFG] Error fetching outbound aggregates data",
              error
            )
          );

        let businessUnitsPromise = fetch(
          "/outboundForecastGenerator/test/source/businessUnits.json"
        )
          .then((response) => response.json())
          .then((data) => data.entities)
          .catch((error) =>
            console.error("[OFG] Error fetching business units data", error)
          );

        let businessUnitSettingsPromise = fetch(
          "/outboundForecastGenerator/test/source/bu.json"
        )
          .then((response) => response.json())
          .catch((error) =>
            console.error(
              "[OFG] Error fetching business unit settings data",
              error
            )
          );

        let planningGroupsPromise = fetch(
          "/outboundForecastGenerator/test/source/planningGroups.json"
        )
          .then((response) => response.json())
          .then((data) => data.entities)
          .catch((error) =>
            console.error("[OFG] Error fetching planning groups data", error)
          );

        let campaignsPromise = fetch(
          "/outboundForecastGenerator/test/source/campaigns.json"
        )
          .then((response) => response.json())
          .then((data) => data.entities)
          .catch((error) =>
            console.error("[OFG] Error fetching campaigns data", error)
          );

        let inboundFcDataPromise = fetch(
          "/outboundForecastGenerator/test/source/inboundForecastData.json"
        )
          .then((response) => response.json())
          .then((data) => data)
          .catch((error) =>
            console.error("[OFG] Error fetching inbound forecast data", error)
          );

        // Create mock objects for testing
        window.ofg.PlatformClient = {
          MockAnalyticsApi: {
            getOutboundConversationsAggregates: function () {
              // Return promise from fetch
              return outboundAggregatesDataPromise;
            },
          },

          MockOutboundApi: {
            getOutboundCampaigns: function () {
              // Return promise from fetch
              return campaignsPromise;
            },
          },
          MockWfmApi: {
            getBusinessUnits: function () {
              // Return promise from fetch
              return businessUnitsPromise;
            },
            getBusinessUnitData: function () {
              // Return promise from fetch
              return businessUnitSettingsPromise;
            },
            getPlanningGroups: function () {
              // Return promise from fetch
              return planningGroupsPromise;
            },
            getInboundForecastData: function () {
              // Return promise from fetch
              return inboundFcDataPromise;
            },
          },
          // ...
        };
      } else {
        console.log("[OFG] Production mode");

        // Define PlatformClient here
        let platformClientModule = window.require("platformClient");

        // Configure Platform Client
        window.ofg.PlatformClient = platformClientModule;
        window.ofg.PlatformClient.ApiClient.instance.setEnvironment(
          environment
        );
        window.ofg.PlatformClient.ApiClient.instance.setReturnExtendedResponses(
          true
        );
        window.ofg.PlatformClient.ApiClient.instance.setPersistSettings(
          true,
          "ofg"
        );

        // Configure Client App
        let ClientAppModule = window.purecloud.apps.ClientApp;
        window.ofg.ClientApp = new ClientAppModule({
          pcEnvironment: environment,
        });
      }
    </script>

    <!-- Script to login with Cloud -->
    <script type="module">
      import { startSession } from "./src/sessionHandler.js";
      import { loadPageOne } from "./src/pageHandler.js";

      document.addEventListener("DOMContentLoaded", async function () {
        if (!window.ofg.isTesting) {
          // Extract clientId and environment from URL query parameters
          const urlParams = new URLSearchParams(window.location.search);
          const clientId = urlParams.get("clientId");
          const environment = urlParams.get("environment");

          if (!clientId || !environment) {
            console.error(
              "[OFG] Check clientId and environment in URL query parameters",
              window.location
            );
            alert(
              "Please provide clientId and environment in the URL query parameters"
            );
            return;
          }

          try {
            await window.ofg.PlatformClient.ApiClient.instance.loginImplicitGrant(
              clientId,
              "https://apmaries.github.io/outboundForecastGenerator/wfm-outbound.html"
            );
            sessionStorage.setItem("oauth_client", clientId);
            sessionStorage.setItem("org_env", environment);
            console.log("[OFG] Logged in to Genesys Cloud");
          } catch (e) {
            console.error("[OFG] Error logging in", e);
          }
        }
        await startSession();
        loadPageOne();
      });
    </script>

    <!-- Main project module -->
    <script type="module" src="/outboundForecastGenerator/src/main.js"></script>
  </body>
</html>
