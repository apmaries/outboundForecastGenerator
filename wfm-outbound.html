<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!--Removes Google Crawler from indexing page-->
    <meta name="robots" content="noindex" />

    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>Outbound Forecast Generator</title>

    <!-- Genesys stuff -->
    <link
      href="https://dhqbrvplips7x.cloudfront.net/common-ui-docs/genesys-webcomponents/3.8.1-178/genesys-webcomponents/genesys-webcomponents.css"
      rel="stylesheet"
    />
    <script
      type="module"
      src="https://dhqbrvplips7x.cloudfront.net/common-ui-docs/genesys-webcomponents/3.8.1-178/genesys-webcomponents/genesys-webcomponents.esm.js"
    ></script>
    <script src="https://sdk-cdn.mypurecloud.com/javascript/latest/purecloud-platform-client-v2.min.js"></script>

    <!-- External -->
    <script src="https://moment.github.io/luxon/global/luxon.min.js"></script>

    <!-- Project -->
    <script src="./src/makeApiCall.js"></script>
    <script src="./src/numberCruncher.js"></script>
    <script src="./src/session.js"></script>
    <script src="./src/main.js"></script>

    <style>
      .slotted {
        font-family: Roboto, sans-serif;
        font-weight: 600;
        font-size: 12px;
        line-height: 16px;
      }
      .error {
        border: 2px solid red;
      }

      .form-container {
        display: inline-flex;
        flex-direction: column;
        width: 400px;
      }

      .width {
        width: 100%;
      }

      .row {
        display: flex;
        gap: 10px;
      }

      .row .width {
        flex: 1;
      }

      .align-right {
        margin-left: auto;
      }
    </style>
  </head>
  <body>
    <h1>Outbound Forecast Generator</h1>

    <fieldset class="form-container">
      <legend>Parameters</legend>
      <gux-form-field-dropdown class="width">
        <gux-dropdown>
          <gux-listbox
            id="businessUnit"
            onchange="updateBusinessUnitSettings()"
          >
            <gux-option value="a">Ant</gux-option>
            <gux-option value="b">Bat</gux-option>
            <gux-option value="c">Cat</gux-option>
          </gux-listbox>
        </gux-dropdown>
        <label slot="label">Business Unit</label>
      </gux-form-field-dropdown>

      <gux-form-field-number style="width: 100%">
        <input
          slot="input"
          type="number"
          id="numContacts"
          min="0"
          max="100000"
          value="0"
          step="500"
        />
        <label class="width" slot="label">Number of contacts</label>
      </gux-form-field-number>

      <gux-form-field-number style="width: 100%">
        <input
          slot="input"
          type="number"
          id="historicalWeeks"
          value="6"
          step="1"
          min="1"
          max="8"
        />
        <label class="width" slot="label">Forecast historical weeks</label>
      </gux-form-field-number>

      <label for="weekStart" class="slotted">Week start</label>
      <gux-datepicker
        start-day-of-week="1"
        id="weekStart"
        format="dd/mm/yyyy"
        class="width"
      ></gux-datepicker>

      <label for="inclSchedule">Generate schedule too?</label>
      <gux-toggle
        id="inclSchedule"
        checked-label="Yes"
        unchecked-label="No"
      ></gux-toggle>

      <gux-button accent="primary" onclick="buttonClicked()">Run!</gux-button>
    </fieldset>

    <!-- <form id="form">
      <label for="businessUnit">Business Unit:</label>

      <select
        id="businessUnit"
        onchange="updateBusinessUnitSettings()"
        required
      ></select>

      <label for="weekStart">Week Start:</label>
      <gux-datepicker
        start-day-of-week="1"
        id="weekStart"
        format="dd/mm/yyyy"
        required
      ></gux-datepicker>

      <label for="numContacts">Number of Contacts:</label>
      <input type="number" id="numContacts" min="0" value="0" required />

      <label for="historicalWeeks">Historical Weeks:</label>
      <input type="number" id="historicalWeeks" min="0" max="8" required />

      <label for="inclSchedule">Auto add schedule with forecast?:</label>
      <gux-toggle
        id="inclScheduke"
        checked-label="Yes"
        unchecked-label="No"
      ></gux-toggle>

      <button type="button" onclick="buttonClicked()">Run!</button>
      
    </form>-->

    <script>
      console.log("Outbound Forecast Generator (OFG) initiated");

      var environment = sessionStorage.getItem("environment");
      var token = sessionStorage.getItem("token");

      var selectedBuId;
      var selectedBuTimeZone;

      // Set Genesys Cloud objects
      const platformClient = require("platformClient");
      const client = platformClient.ApiClient.instance;
      client.setAccessToken(token);

      const oapi = new platformClient.OrganizationApi();
      const uapi = new platformClient.UsersApi();
      const wapi = new platformClient.WorkforceManagementApi();

      // Simulate fetching Business Unit values from an API
      function fetchBusinessUnits() {
        console.log("OFG: Getting WFM Business Units");
        // Replace this with an actual API call
        wapi
          .getWorkforcemanagementBusinessunits()
          .then((data) => {
            console.log(
              `OFG: getWorkforcemanagementBusinessunits success! data: ${JSON.stringify(
                data,
                null,
                2
              )}`
            );
          })
          .catch((err) => {
            console.log(
              "OFG: There was a failure calling getWorkforcemanagementBusinessunits"
            );
            console.error(err);
          });

        return [
          {
            "id": "7e5d7b10-9086-4c53-8458-xxxxxxxxxxxx",
            "name": "amBluthCo",
            "settings": {
              "startDayOfWeek": "Monday",
              "timeZone": "Australia/Sydney",
              "shortTermForecasting": {
                "defaultHistoryWeeks": 6,
              },
            },
          },
          // Add more Business Units as needed
        ];
      }

      // Populate Business Unit dropdown options
      function populateBusinessUnits() {
        var businessUnitDropdown = document.getElementById("businessUnit");
        var businessUnits = fetchBusinessUnits();

        businessUnits.forEach(function (unit) {
          var option = document.createElement("gux-option");
          option.value = unit.id;
          option.textContent = unit.name;
          businessUnitDropdown.appendChild(option);
        });
      }

      // Update selected Business Unit settings
      function updateBusinessUnitSettings() {
        var businessUnitDropdown = document.getElementById("businessUnit");
        var selectedIndex = businessUnitDropdown.selectedIndex;
        selectedBuId = businessUnitDropdown.options[selectedIndex].value;
        var buSettings = fetchBusinessUnits().find(
          (unit) => unit.id === selectedBuId
        ).settings;
        selectedBuTimeZone = buSettings.timeZone;

        // Restrict weekStart input to the selected BU's startDayOfWeek
        var startDayOfWeek = buSettings.startDayOfWeek;
        document.getElementById("weekStart").min = startDayOfWeek;

        // Set default value for weekStart to the next occurrence of startDayOfWeek in the specified time zone
        var currentDate = luxon.DateTime.now({ zone: selectedBuTimeZone });
        var currentDayOfWeek = getDayOfWeek(currentDate.weekdayLong);

        // Adjust for Monday as the start of the week
        var daysUntilNextStartDay =
          (getDayOfWeek(startDayOfWeek) - currentDayOfWeek + 7) % 7;
        var nextStartDay = currentDate.plus({ days: daysUntilNextStartDay });

        document.getElementById("weekStart").valueAsDate =
          nextStartDay.toJSDate();
      }

      // Helper function to get day of week index (0-6) from day name
      function getDayOfWeek(dayName) {
        var days = [
          "Sunday",
          "Monday",
          "Tuesday",
          "Wednesday",
          "Thursday",
          "Friday",
          "Saturday",
        ];
        return days.indexOf(dayName);
      }

      // Populate default values on page load
      window.onload = function () {
        populateBusinessUnits();
        updateBusinessUnitSettings();

        // Set default value for historicalWeeks
        document.getElementById("historicalWeeks").value =
          fetchBusinessUnits().find(
            (unit) => unit.id === selectedBuId
          ).settings.shortTermForecasting.defaultHistoryWeeks;
      };

      // buttonClicked function
      function buttonClicked() {
        // Get input values
        var weekStartInput = document.getElementById("weekStart");
        var numContactsInput = document.getElementById("numContacts");
        var historicalWeeks = document.getElementById("historicalWeeks").value;

        // Check if weekStart day of week matches selected BU's startDayOfWeek
        var selectedBuStartDayOfWeek = fetchBusinessUnits().find(
          (unit) => unit.id === selectedBuId
        ).settings.startDayOfWeek;
        var selectedWeekStart = new Date(weekStartInput.value);
        if (
          selectedWeekStart.getDay() !== getDayOfWeek(selectedBuStartDayOfWeek)
        ) {
          alert(
            "Week Start day must match Business Unit's startDayOfWeek (" +
              selectedBuStartDayOfWeek +
              ")."
          );
          highlightInputError(weekStartInput);
          return;
        } else {
          removeInputError(weekStartInput);
        }

        // Check if numContacts is 0
        if (numContactsInput.value === "0") {
          alert("Number of Contacts must be greater than 0.");
          highlightInputError(numContactsInput);
          return;
        } else {
          removeInputError(numContactsInput);
        }

        // Check if numContacts is a positive integer
        if (!/^\d+$/.test(numContactsInput.value)) {
          alert("Number of Contacts must be a positive integer.");
          highlightInputError(numContactsInput);
          return;
        } else {
          removeInputError(numContactsInput);
        }

        // Perform calculations or any other desired actions
        // For demonstration, just log the values to the console
        /*console.log("Selected BU ID:", selectedBuId);
        console.log("Selected BU TimeZone:", selectedBuTimeZone);
        console.log("Week Start:", weekStartInput.value);
        console.log("Number of Contacts:", numContactsInput.value);
        console.log("Historical Weeks:", historicalWeeks);*/

        runHelper(
          selectedBuId,
          selectedBuTimeZone,
          weekStartInput.value,
          numContactsInput.value,
          historicalWeeks
        );
      }

      // Helper function to highlight input error
      function highlightInputError(inputElement) {
        inputElement.classList.add("error");
      }

      // Helper function to remove input error highlight
      function removeInputError(inputElement) {
        inputElement.classList.remove("error");
      }
    </script>
  </body>
</html>
