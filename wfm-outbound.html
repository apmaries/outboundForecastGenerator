<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!--Removes Google Crawler from indexing page-->
    <meta name="robots" content="noindex" />

    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>Outbound Forecast Generator</title>

    <!-- Genesys stuff -->
    <link
      href="https://dhqbrvplips7x.cloudfront.net/common-ui-docs/genesys-webcomponents/3.8.1-178/genesys-webcomponents/genesys-webcomponents.css"
      rel="stylesheet"
    />
    <script
      type="module"
      src="https://dhqbrvplips7x.cloudfront.net/common-ui-docs/genesys-webcomponents/3.8.1-178/genesys-webcomponents/genesys-webcomponents.esm.js"
    ></script>
    <script src="https://sdk-cdn.mypurecloud.com/javascript/latest/purecloud-platform-client-v2.min.js"></script>

    <!-- External -->
    <script src="https://moment.github.io/luxon/global/luxon.min.js"></script>

    <!-- Project -->
    <script src="./src/makeApiCall.js"></script>
    <script src="./src/planningGroups.js"></script>
    <script src="./src/numberCruncher.js"></script>
    <script src="./src/session.js"></script>
    <script src="./src/main.js"></script>

    <style>
      .slotted {
        font-family: Roboto, sans-serif;
        font-weight: 600;
        font-size: 12px;
        line-height: 16px;
      }
      .error {
        border: 2px solid red;
      }

      .form-container {
        display: inline-flex;
        flex-direction: column;
        width: 400px;
      }

      .width {
        width: 100%;
      }

      .row {
        display: flex;
        gap: 10px;
      }

      .row .width {
        flex: 1;
      }

      .align-right {
        margin-left: auto;
      }

      .page {
        display: none;

        opacity: 0;
        transition: opacity 0.5s ease-in-out;
      }

      .page.active {
        display: block;
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <h1>Outbound Forecast Generator</h1>
    <div id="user-welcome" hidden></div>

    <div id="page-one" class="page active">
      <fieldset class="form-container">
        <legend>Forecast Parameters</legend>
        <gux-loading-message-beta id="loading-message">
          <div slot="primary-message">Loading BU data...</div>
          <gux-radial-progress
            id="radial-progress"
            slot="progress"
            value="0"
            max="1000"
            screenreader-text="loading"
          ></gux-radial-progress>
        </gux-loading-message-beta>
        <div id="parameters" hidden>
          <gux-form-field-dropdown class="width">
            <gux-dropdown>
              <gux-listbox
                id="businessUnit"
                onchange="updateBusinessUnitSettings()"
              >
              </gux-listbox>
            </gux-dropdown>
            <label slot="label">Business Unit</label>
          </gux-form-field-dropdown>

          <gux-form-field-number style="width: 100%">
            <input
              slot="input"
              type="number"
              id="historicalWeeks"
              value="6"
              step="1"
              min="1"
              max="8"
            />
            <label class="width" slot="label">Forecast historical weeks</label>
          </gux-form-field-number>

          <label for="weekStart" class="slotted">Week start</label>
          <gux-datepicker
            start-day-of-week="1"
            id="weekStart"
            format="dd/mm/yyyy"
            class="width"
          ></gux-datepicker>

          <label for="inclSchedule">Generate schedule too?</label>
          <gux-toggle
            id="inclSchedule"
            checked-label="Yes"
            unchecked-label="No"
          ></gux-toggle>

          <gux-button accent="secondary" onclick="nextPage()">Next</gux-button>
        </div>
      </fieldset>
    </div>

    <div id="page-two" class="page">
      <fieldset class="form-container">
        <legend>Planning Groups</legend>
        <div id="planning-groups">
          <gux-form-field-number style="width: 100%">
            <input
              slot="input"
              type="number"
              id="numContacts"
              min="0"
              max="100000"
              value="0"
              step="500"
            />
            <label class="width" slot="label">Number of contacts</label>
          </gux-form-field-number>
        </div>
        <div id="buttons" class="row">
          <gux-button accent="secondary" class="align-left" onclick="prevPage()"
            >Back</gux-button
          >
          <gux-button
            accent="primary"
            class="align-right"
            onclick="buttonClicked()"
            >Run!</gux-button
          >
        </div>
      </fieldset>
    </div>

    <script>
      console.log("Outbound Forecast Generator (OFG) initiated");

      var token = sessionStorage.getItem("token");
      const wfmBuStorage = "wfmBuList";
      var selectedBuId;
      var selectedBuTimeZone;

      // Set Genesys Cloud objects
      /*const platformClient = require("platformClient");
      const client = platformClient.ApiClient.instance;
      client.setAccessToken(token);

      const oapi = new platformClient.OrganizationApi();
      const uapi = new platformClient.UsersApi();
      const wapi = new platformClient.WorkforceManagementApi();*/

      async function fetchBusinessUnits(allBuData, nBu) {
        const buArray = [];
        // set progress max
        let radialProgress = document.getElementById("radial-progress");
        let progressValue = 0;
        radialProgress.setAttribute("max", nBu.toString());

        let allTzData = await fetchDataWithRetry(
          `/api/v2/timezones?pageSize=500&pageNumber=1`,
          "GET"
        );

        // get individual BU settings
        console.log(`OFG: Getting BU settings`);
        for (let b = 0; b < allBuData.length; b++) {
          progressValue++;
          let businessUnitId = allBuData[b].id;
          let businessUnitName = allBuData[b].name;

          let buData = await fetchDataWithRetry(
            `/api/v2/workforcemanagement/businessunits/${businessUnitId}?expand=settings.timeZone,settings.startDayOfWeek,settings.shortTermForecasting`,
            "GET"
          );

          // increment progress
          radialProgress.setAttribute("value", progressValue);

          // get bu settings
          let businessUnitStartDayOfWeek = buData.settings.startDayOfWeek;
          let businessUnitDefaultHistoryWeeks =
            buData.settings.shortTermForecasting.defaultHistoryWeeks;

          let businessUnitTimeZone = buData.settings.timeZone;
          let timezoneOffset = allTzData.find(
            (tz) => tz.id === businessUnitTimeZone
          );
          let businessUnitTimeZoneOffset = timezoneOffset.offset;

          let bu = {
            "name": businessUnitName,
            "id": businessUnitId,
            "startDayOfWeek": businessUnitStartDayOfWeek,
            "defaultHistoryWeeks": businessUnitDefaultHistoryWeeks,
            "timeZone": businessUnitTimeZone,
            "offset": businessUnitTimeZoneOffset,
          };
          console.debug(`OFG: ${JSON.stringify(bu)}`);
          buArray.push(bu);
        }

        // set session storage
        sessionStorage.setItem(wfmBuStorage, JSON.stringify(buArray));

        // unhide parameters div
        const loadingMessageElement =
          document.getElementById("loading-message");
        loadingMessageElement.style.display = "none";
        document.getElementById("parameters").removeAttribute("hidden");

        return buArray;
      }

      // Populate Business Unit dropdown options
      async function populateBusinessUnits(businessUnits) {
        var businessUnitDropdown = document.getElementById("businessUnit");

        // Sort the buData array alphabetically based on bu_name
        businessUnits.sort((a, b) => a.name.localeCompare(b.name));

        for (let i = 0; i < businessUnits.length; i++) {
          const unit = businessUnits[i];
          var option = document.createElement("gux-option");
          option.value = unit.id;
          option.textContent = unit.name;
          businessUnitDropdown.appendChild(option);
        }
      }

      // Update selected Business Unit settings
      function updateBusinessUnitSettings() {
        const buArray = JSON.parse(sessionStorage.getItem(wfmBuStorage));

        var businessUnitDropdown = document.getElementById("businessUnit");
        var selectedBuId = businessUnitDropdown.value;
        console.log(`OFG: User selected BU - ${JSON.stringify(selectedBuId)}`);

        // up to here
        var buObj = buArray.find((unit) => unit.id === selectedBuId);
        var selectedBuStartDayOfWeek = buObj.startDayOfWeek;
        var selectedBuTimeZone = buObj.timeZone;
        var selectedBuDefaultHistoryWeeks = buObj.defaultHistoryWeeks;
        console.log(JSON.stringify(buObj));

        // Set default value for historicalWeeks
        document.getElementById("historicalWeeks").value =
          selectedBuDefaultHistoryWeeks;

        // Restrict weekStart input to the selected BU's startDayOfWeek
        document.getElementById("weekStart").min = selectedBuStartDayOfWeek;

        // Set default value for weekStart to the next occurrence of startDayOfWeek in the specified time zone
        var currentDate = luxon.DateTime.now({ zone: selectedBuTimeZone });
        var currentDayOfWeek = getDayOfWeek(currentDate.weekdayLong);

        // Adjust for Monday as the start of the week
        var daysUntilNextStartDay =
          (getDayOfWeek(selectedBuStartDayOfWeek) - currentDayOfWeek + 7) % 7;
        var nextStartDay = currentDate.plus({ days: daysUntilNextStartDay });

        document.getElementById("weekStart").valueAsDate =
          nextStartDay.toJSDate();

        return buObj;
      }

      // Helper function to get day of week index (0-6) from day name
      function getDayOfWeek(dayName) {
        var days = [
          "Sunday",
          "Monday",
          "Tuesday",
          "Wednesday",
          "Thursday",
          "Friday",
          "Saturday",
        ];
        return days.indexOf(dayName);
      }

      // Populate default values on page load
      window.onload = async function () {
        await getOrgLevelStuff();

        let buData;

        let allBuData = await fetchDataWithRetry(
          `/api/v2/workforcemanagement/businessunits`,
          "GET"
        );

        let buCount = allBuData.length;

        if (buCount > 0) {
          await populateBusinessUnits(allBuData);
          console.log(`OFG: Found ${buCount} Business Units in WFM`);
          const buArray = await fetchBusinessUnits(allBuData, buCount);
        } else {
          console.error(`OFG: No business units found in WFM`);
        }
      };

      // buttonClicked function
      function buttonClicked() {
        // Get input values

        const buArray = JSON.parse(sessionStorage.getItem(wfmBuStorage));

        var businessUnitDropdown = document.getElementById("businessUnit");
        var selectedBuId = businessUnitDropdown.value;
        console.log(`OFG: Running for BU - ${JSON.stringify(selectedBuId)}`);

        // up to here
        var buObj = buArray.find((unit) => unit.id === selectedBuId);
        var selectedBuName = buObj.name;
        var selectedBuStartDayOfWeek = buObj.startDayOfWeek;
        var selectedBuTimeZone = buObj.timeZone;
        var selectedBuDefaultHistoryWeeks = buObj.defaultHistoryWeeks;
        console.log(JSON.stringify(buObj));

        var weekStartInput = document.getElementById("weekStart");
        var numContactsInput = document.getElementById("numContacts");
        var historicalWeeks = document.getElementById("historicalWeeks");

        // Check if weekStart day of week matches selected BU's startDayOfWeek
        var selectedWeekStart = new Date(weekStartInput.value);
        if (
          selectedWeekStart.getDay() !== getDayOfWeek(selectedBuStartDayOfWeek)
        ) {
          alert(
            "Week Start day must match Business Unit's startDayOfWeek (" +
              selectedBuStartDayOfWeek +
              ")."
          );
          console.error(
            "Week Start day must match Business Unit's startDayOfWeek (" +
              selectedBuStartDayOfWeek +
              ")."
          );
          highlightInputError(weekStartInput);
          return;
        } else {
          removeInputError(weekStartInput);
        }

        // Check if numContacts is 0
        if (numContactsInput.value === "0") {
          alert("Number of Contacts must be greater than 0.");
          console.error("Number of Contacts must be greater than 0.");
          highlightInputError(numContactsInput);
          return;
        } else {
          removeInputError(numContactsInput);
        }

        // Check if numContacts is a positive integer
        if (!/^\d+$/.test(numContactsInput.value)) {
          alert("Number of Contacts must be a positive integer.");
          highlightInputError(numContactsInput);
          return;
        } else {
          removeInputError(numContactsInput);
        }

        // Perform calculations or any other desired actions
        // For demonstration, just log the values to the console
        /*console.log("Selected BU ID:", selectedBuId);
        console.log("Selected BU TimeZone:", selectedBuTimeZone);
        console.log("Week Start:", weekStartInput.value);
        console.log("Number of Contacts:", numContactsInput.value);
        console.log("Historical Weeks:", historicalWeeks);*/

        runHelper(
          selectedBuName,
          selectedBuId,
          selectedBuTimeZone,
          weekStartInput.value,
          numContactsInput.value,
          historicalWeeks.value
        );
      }

      // Helper function to highlight input error
      function highlightInputError(inputElement) {
        inputElement.classList.add("error");
      }

      // Helper function to remove input error highlight
      function removeInputError(inputElement) {
        inputElement.classList.remove("error");
      }

      function nextPage() {
        const pageOne = document.getElementById("page-one");
        const pageTwo = document.getElementById("page-two");

        pageOne.classList.remove("active");

        setTimeout(() => {
          pageTwo.classList.add("active");

          // Add an event listener for the "load" event on the "page-two" element
          pageTwo.addEventListener("load", function () {
            // Run another function after "page-two" has loaded
            var businessUnitDropdown = document.getElementById("businessUnit");
            var selectedBuId = businessUnitDropdown.value;
            loadPageTwo(selectedBuId);
          });
        }, 100); // Delay for a smoother transition
      }

      function prevPage() {
        document.getElementById("page-two").classList.remove("active");
        setTimeout(() => {
          document.getElementById("page-one").classList.add("active");
        }, 100); // Delay for a smoother transition
      }
    </script>
  </body>
</html>
